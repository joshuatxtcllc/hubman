// package.json
{
â€œnameâ€: â€œjays-frames-trackerâ€,
â€œversionâ€: â€œ1.0.0â€,
â€œdescriptionâ€: â€œOrder tracking system for Jayâ€™s Framesâ€,
â€œmainâ€: â€œserver.jsâ€,
â€œscriptsâ€: {
â€œstartâ€: â€œnode server.jsâ€,
â€œdevâ€: â€œnodemon server.jsâ€,
â€œbuildâ€: â€œnpm installâ€
},
â€œdependenciesâ€: {
â€œexpressâ€: â€œ^4.18.2â€,
â€œtwilioâ€: â€œ^4.19.0â€,
â€œsqlite3â€: â€œ^5.1.6â€,
â€œbody-parserâ€: â€œ^1.20.2â€,
â€œcorsâ€: â€œ^2.8.5â€,
â€œdotenvâ€: â€œ^16.3.1â€,
â€œhelmetâ€: â€œ^7.1.0â€
},
â€œdevDependenciesâ€: {
â€œnodemonâ€: â€œ^3.0.2â€
}
}

// .env (Create this file and add your actual Twilio credentials)
TWILIO_ACCOUNT_SID=your_twilio_account_sid_here
TWILIO_AUTH_TOKEN=your_twilio_auth_token_here
TWILIO_PHONE_NUMBER=+1234567890
PORT=3000

// server.js
const express = require(â€˜expressâ€™);
const bodyParser = require(â€˜body-parserâ€™);
const cors = require(â€˜corsâ€™);
const helmet = require(â€˜helmetâ€™);
const sqlite3 = require(â€˜sqlite3â€™).verbose();
const twilio = require(â€˜twilioâ€™);
require(â€˜dotenvâ€™).config();

const app = express();
const port = process.env.PORT || 3000;

// Middleware
app.use(helmet());
app.use(cors());
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));
app.use(express.static(â€˜publicâ€™));

// Initialize Twilio
const twilioClient = twilio(
process.env.TWILIO_ACCOUNT_SID,
process.env.TWILIO_AUTH_TOKEN
);

// Initialize SQLite Database
const db = new sqlite3.Database(â€˜orders.dbâ€™);

// Create tables if they donâ€™t exist
db.serialize(() => {
db.run(`CREATE TABLE IF NOT EXISTS orders ( id INTEGER PRIMARY KEY AUTOINCREMENT, order_number TEXT UNIQUE, customer_name TEXT, customer_phone TEXT, customer_email TEXT, frame_type TEXT, dimensions TEXT, special_instructions TEXT, status TEXT DEFAULT 'received', sms_enabled BOOLEAN DEFAULT 1, created_at DATETIME DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME DEFAULT CURRENT_TIMESTAMP )`);

db.run(`CREATE TABLE IF NOT EXISTS status_updates ( id INTEGER PRIMARY KEY AUTOINCREMENT, order_id INTEGER, old_status TEXT, new_status TEXT, notes TEXT, created_at DATETIME DEFAULT CURRENT_TIMESTAMP, FOREIGN KEY (order_id) REFERENCES orders (id) )`);
});

// Order status options
const ORDER_STATUSES = {
â€˜receivedâ€™: â€˜Order received and in queueâ€™,
â€˜measuringâ€™: â€˜Taking measurements and preparing materialsâ€™,
â€˜cuttingâ€™: â€˜Cutting frame piecesâ€™,
â€˜assemblyâ€™: â€˜Assembling your custom frameâ€™,
â€˜quality_checkâ€™: â€˜Final quality inspectionâ€™,
â€˜readyâ€™: â€˜Ready for pickup/deliveryâ€™,
â€˜completedâ€™: â€˜Order completedâ€™,
â€˜cancelledâ€™: â€˜Order cancelledâ€™
};

// SMS sending function
async function sendOrderUpdate(phone, orderNumber, status, notes = â€˜â€™) {
if (!phone || !process.env.TWILIO_PHONE_NUMBER) {
console.log(â€˜SMS not sent - missing phone number or Twilio configâ€™);
return false;
}

try {
const message = `ðŸ–¼ï¸ Jay's Frames Update\n\nOrder #${orderNumber}\nStatus: ${ORDER_STATUSES[status]}\n${notes ? '\nNote: ' + notes : ''}\n\nQuestions? Reply to this message!`;

```
await twilioClient.messages.create({
  body: message,
  from: process.env.TWILIO_PHONE_NUMBER,
  to: phone
});

console.log(`SMS sent to ${phone} for order ${orderNumber}`);
return true;
```

} catch (error) {
console.error(â€˜Error sending SMS:â€™, error);
return false;
}
}

// API Routes

// Get all orders
app.get(â€™/api/ordersâ€™, (req, res) => {
db.all(â€˜SELECT * FROM orders ORDER BY created_at DESCâ€™, [], (err, rows) => {
if (err) {
res.status(500).json({ error: err.message });
return;
}
res.json(rows);
});
});

// Get single order
app.get(â€™/api/orders/:orderNumberâ€™, (req, res) => {
const orderNumber = req.params.orderNumber;

db.get(â€˜SELECT * FROM orders WHERE order_number = ?â€™, [orderNumber], (err, row) => {
if (err) {
res.status(500).json({ error: err.message });
return;
}
if (!row) {
res.status(404).json({ error: â€˜Order not foundâ€™ });
return;
}

```
// Get status history
db.all(
  'SELECT * FROM status_updates WHERE order_id = ? ORDER BY created_at DESC',
  [row.id],
  (err, updates) => {
    if (err) {
      res.status(500).json({ error: err.message });
      return;
    }
    res.json({ ...row, status_history: updates });
  }
);
```

});
});

// Create new order
app.post(â€™/api/ordersâ€™, async (req, res) => {
const {
customer_name,
customer_phone,
customer_email,
frame_type,
dimensions,
special_instructions,
sms_enabled
} = req.body;

// Generate order number
const orderNumber = â€˜JFâ€™ + Date.now().toString().slice(-6);

db.run(
`INSERT INTO orders ( order_number, customer_name, customer_phone, customer_email, frame_type, dimensions, special_instructions, sms_enabled ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
[orderNumber, customer_name, customer_phone, customer_email, frame_type, dimensions, special_instructions, sms_enabled],
async function(err) {
if (err) {
res.status(500).json({ error: err.message });
return;
}

```
  // Send confirmation SMS if enabled
  if (sms_enabled && customer_phone) {
    await sendOrderUpdate(
      customer_phone,
      orderNumber,
      'received',
      'We\'ll keep you updated on your custom frame progress!'
    );
  }
  
  res.json({
    id: this.lastID,
    order_number: orderNumber,
    message: 'Order created successfully'
  });
}
```

);
});

// Update order status
app.put(â€™/api/orders/:orderNumber/statusâ€™, async (req, res) => {
const orderNumber = req.params.orderNumber;
const { status, notes } = req.body;

if (!ORDER_STATUSES[status]) {
res.status(400).json({ error: â€˜Invalid statusâ€™ });
return;
}

// Get current order
db.get(â€˜SELECT * FROM orders WHERE order_number = ?â€™, [orderNumber], async (err, order) => {
if (err) {
res.status(500).json({ error: err.message });
return;
}
if (!order) {
res.status(404).json({ error: â€˜Order not foundâ€™ });
return;
}

```
const oldStatus = order.status;

// Update order status
db.run(
  'UPDATE orders SET status = ?, updated_at = CURRENT_TIMESTAMP WHERE order_number = ?',
  [status, orderNumber],
  async function(err) {
    if (err) {
      res.status(500).json({ error: err.message });
      return;
    }

    // Log status change
    db.run(
      'INSERT INTO status_updates (order_id, old_status, new_status, notes) VALUES (?, ?, ?, ?)',
      [order.id, oldStatus, status, notes || '']
    );

    // Send SMS update if enabled
    if (order.sms_enabled && order.customer_phone) {
      await sendOrderUpdate(order.customer_phone, orderNumber, status, notes);
    }

    res.json({
      message: 'Order status updated successfully',
      order_number: orderNumber,
      old_status: oldStatus,
      new_status: status
    });
  }
);
```

});
});

// Customer order lookup (public endpoint)
app.get(â€™/api/public/orders/:orderNumberâ€™, (req, res) => {
const orderNumber = req.params.orderNumber;

db.get(
â€˜SELECT order_number, customer_name, frame_type, dimensions, status, created_at, updated_at FROM orders WHERE order_number = ?â€™,
[orderNumber],
(err, row) => {
if (err) {
res.status(500).json({ error: â€˜Database errorâ€™ });
return;
}
if (!row) {
res.status(404).json({ error: â€˜Order not foundâ€™ });
return;
}

```
  res.json({
    ...row,
    status_description: ORDER_STATUSES[row.status]
  });
}
```

);
});

// Handle Twilio webhook for incoming SMS
app.post(â€™/webhook/smsâ€™, (req, res) => {
const { From, Body } = req.body;

console.log(`Received SMS from ${From}: ${Body}`);

// You can implement auto-responses here
// For now, just log the message

res.set(â€˜Content-Typeâ€™, â€˜text/xmlâ€™);
res.send(`<Response> <Message>Thanks for your message! We'll get back to you soon. For immediate assistance, call us directly.</Message> </Response>`);
});

// Handle Twilio webhook for incoming voice calls
app.post(â€™/webhook/voiceâ€™, (req, res) => {
console.log(â€˜Incoming call receivedâ€™);

res.set(â€˜Content-Typeâ€™, â€˜text/xmlâ€™);
res.send(`<Response> <Say voice="alice">Thank you for calling Jay's Frames! For order updates, please text your order number to this number or visit our website. Have a great day!</Say> </Response>`);
});

// Start server
app.listen(port, () => {
console.log(`Jay's Frames Order Tracker running on port ${port}`);
console.log(`Access admin panel at http://localhost:${port}/admin.html`);
console.log(`Customer tracking at http://localhost:${port}/track.html`);
});

// Graceful shutdown
process.on(â€˜SIGINTâ€™, () => {
console.log(â€˜Shutting down gracefullyâ€¦â€™);
db.close();
process.exit(0);
});